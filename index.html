<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alarm Task</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f9f9f9;
      color: #333;
      max-width: 500px;
      margin: auto;
    }
    h1 {
      text-align: center;
      font-size: 1.6rem;
    }
    #task, .question {
      margin-top: 2rem;
      font-size: 1.3rem;
    }
    input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem;
      font-size: 1rem;
      width: 100%;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 6px;
    }
    .hint {
      font-size: 1rem;
      color: #555;
    }
    #qr-reader {
      width: 100%;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Complete Your Task</h1>
  <div id="task">Loading...</div>

  <script>
    const backendURL = "https://alarmclock-dopk.onrender.com";

    function randomInt(min, max, filterFn = () => true) {
      let x;
      do {
        x = Math.floor(Math.random() * (max - min + 1)) + min;
      } while (!filterFn(x));
      return x;
    }

    function generateQuestion() {
      const ops = ["+", "-", "*"];
      const op = ops[Math.floor(Math.random() * ops.length)];

      let a, b;
      if (op === "+") {
        a = randomInt(51, 999, n => n % 5 !== 0);
        b = randomInt(51, 999, n => n % 5 !== 0);
      } else if (op === "-") {
        a = randomInt(51, 999, n => n % 5 !== 0);
        b = randomInt(51, a - 1, n => n % 5 !== 0); // b < a to avoid negatives
      } else if (op === "*") {
        a = randomInt(10, 50);
        const bPool = Array.from({ length: 9 }, (_, i) => i + 2)
          .concat([15, 20, 25, 30, 35, 40, 45, 50]);
        b = bPool[Math.floor(Math.random() * bPool.length)];
      }

      const expression = `${a} ${op} ${b}`;
      const answer = eval(expression);
      return { question: expression, answer };
    }

    async function submitComplete() {
      await fetch(`${backendURL}/mark-complete`, { method: "POST" });
      document.getElementById("task").innerHTML = `<p>✅ Task complete!</p>`;
    }

    function renderMathTask() {
      const taskDiv = document.getElementById("task");
      const questions = [generateQuestion(), generateQuestion(), generateQuestion()];
      let current = 0;

      function askNext() {
        if (current >= questions.length) {
          submitComplete();
          return;
        }

        const { question, answer } = questions[current];
        taskDiv.innerHTML = `
          <div class="question">
            <p>Question ${current + 1}: <strong>${question}</strong></p>
            <input id="answer" type="number" inputmode="numeric" />
            <button id="submit">Submit</button>
          </div>
        `;

        document.getElementById("submit").onclick = () => {
          const userAnswer = Number(document.getElementById("answer").value);
          if (userAnswer === answer) {
            current++;
            askNext();
          } else {
            alert("Incorrect. Try again.");
          }
        };
      }

      askNext();
    }

  function renderQRTask(hint) {
    const taskDiv = document.getElementById("task");
  
    taskDiv.innerHTML = `
      <p class="hint">QR Hint: <strong>${hint}</strong></p>
      <div id="qr-reader"></div>
      <p id="qr-status" style="font-size:0.9rem; color:#777;">Waiting for scan...</p>
    `;
  
    const reader = new Html5Qrcode("qr-reader");
  
    async function verifyQR(value) {
      document.getElementById("qr-status").textContent = "Verifying...";
      try {
        const res = await fetch(`${backendURL}/qr-verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ value })
        });
        const result = await res.json();
  
        if (result.ok) {
          await reader.stop();
          document.getElementById("task").innerHTML = `<p>✅ QR verified!</p>`;
          await submitComplete();
        } else {
          document.getElementById("qr-status").textContent = "Incorrect code. Retrying in 3 seconds...";
          await reader.stop();
          setTimeout(() => startScanner(), 3000);
        }
      } catch (err) {
        document.getElementById("qr-status").textContent = "Error verifying. Retrying in 3 seconds...";
        await reader.stop();
        setTimeout(() => startScanner(), 3000);
      }
    }
  
    function startScanner() {
      document.getElementById("qr-status").textContent = "Scanning...";
      reader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          verifyQR(decodedText);
        },
        (errorMessage) => {
          // decode errors are ignored silently
        }
      );
    }
  
    startScanner();
  }

    async function main() {
      const task = await fetch(`${backendURL}/task-type`).then(r => r.json());
      if (task.type === "math") {
        renderMathTask();
      } else if (task.type === "qr") {
        renderQRTask(task.hint || "No hint provided.");
      }
    }

    main();
  </script>
</body>
</html>
